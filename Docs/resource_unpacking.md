# Overview

Цель: разработать безопасную и удобную механику работы с игровыми ресурсными пакетами (`game.gfx`, `game.pix`, `game.sfx`, `fonts.dat`, `objects.dat`) после копирования в `LocalFolder`.

# Goals

- Доступ к ресурсам без хранения "сырого" контента в сборке.
- Возможность как потокового чтения из паков, так и физической распаковки в кэш для совместимости/отладки.
- Минимум операций записи, предсказуемая структура (`Data`, `Maps`, `Save`, `Cache`).

# Progress

- `RuntimeAssets.DeployAsync` разворачивает базовые файлы и карты в `LocalFolder`.
- Добавлена папка `Cache` для будущей физической распаковки.
- `objects.dat` теперь явно включён в пакет и доступен для копирования.

# Pending

1. Реализовать интерфейсы доступа к пакам:
   - `IGfxProvider` и `ISfxProvider` для извлечения спрайтов/звуков.
   - `IFontProvider` для чтения `fonts.dat` и форматов глифов.
   - `IObjectsProvider` для разбора `objects.dat` (описания объектов).

2. Две стратегии развёртки:
   - Потоковая: читаем из паков по индексам без распаковки на диск (быстрее, меньше IO).
   - Физическая: распаковка в `Cache` (PNG/WAV/JSON) с именами по хешу/идентификатору для отладки и совместимости с текущими загрузчиками.

3. План реализации (итеративно):
   - Этап A (инфраструктура):
     - `RuntimeAssets.UnpackAsync()` — хук после `DeployAsync` (однократно, по версии/маркеру).
     - Индексный читатель паков (`PackIndexReader`) с валидацией магик-байт и таблицы записей.
     - Кэш-менеджер: размещение и именование (`Cache/<type>/<id>.ext`).
   - Этап B (графика):
     - `GfxPackReader`: извлечение спрайтов, палитры (`game.pix`), декодирование формата, генерация PNG в кэш (по необходимости).
   - Этап C (звук):
     - `SfxPackReader`: извлечение сэмплов, декодирование в WAV (или потоковая выдача PCM) для текущего аудио API.
   - Этап D (шрифты/объекты):
     - `FontsDatReader`: парсинг метрики шрифтов, экспорт или прямое использование рендера.
     - `ObjectsDatReader`: парсинг описаний, валидация типов и ссылок на ресурсы.

4. Управление версионированием кэша:
   - Маркер в `LocalFolder` (`Cache/.version`), пересборка кэша при смене версии паков.
   - Чистка устаревших артефактов.

5. Интеграция с текущим кодом:
   - Абстракция `IResourceProvider` для подстановки: сначала проверка `Cache`, затем поток из паков.
   - Мягкая миграция загрузчиков (без жёстких зависимостей на физические файлы).

6. Диагностика и безопасность:
   - Логирование ключевых шагов (кол-во записей, ошибки распаковки).
   - Валидация подписи/магик-байт, контроль операций записи.

